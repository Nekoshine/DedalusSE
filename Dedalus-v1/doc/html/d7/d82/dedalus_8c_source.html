<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Operating System 2: Let&#39;s play in the dedalus!: src/dedalus.c Source File</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />

<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Operating System 2: Let&#39;s play in the dedalus!
   &#160;<span id="projectnumber">1.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Subject</span></a></li>
      <li><a href="../../globals.html"><span>Symbols</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/dedalus.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d7/d82/dedalus_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;getopt.h&gt;</span>   <span class="comment">/* Getopt */</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;limits.h&gt;</span>   <span class="comment">// INT_MAX</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;stdbool.h&gt;</span>  <span class="comment">// bool, true, false</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;stdio.h&gt;</span>    <span class="comment">// printf</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>   <span class="comment">// malloc, rand, srand</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;string.h&gt;</span>   <span class="comment">// strcpy, strlen</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;time.h&gt;</span>     <span class="comment">// time</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/df3/ai_8h.html" title="AI definition and factory.">ai.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d77/ai__random_8h.html" title="Random Artificial Intelligence.">ai/ai_random.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d90/ai__shall__not__pass_8h.html" title="Artificial Intelligence who will not move.">ai/ai_shall_not_pass.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d16/config_8h.html" title="Structure to configure the game.">config.h</a>&quot;</span>   <span class="comment">// configuration</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d68/display_8h.html" title="Methods to display a dedalus.">display.h</a>&quot;</span>  <span class="comment">// Wait user and info</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dd5/game_8h.html" title="Dedalus game controller.">game.h</a>&quot;</span>     <span class="comment">// game setting</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/db7/map_8h.html" title="Map definition and management.">map.h</a>&quot;</span>      <span class="comment">// manage the map</span>
<a name="l00028"></a>00028 
<a name="l00036"></a>00036 <span class="keywordtype">void</span> <a class="code" href="../../d7/d82/dedalus_8c.html#a8437a66ad88c77ef751aeb438166b96c" title="Parse parameters to build the configuration of the game.">read_parameters</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[], <a class="code" href="../../db/d16/config_8h.html#d8/dc0/structconfig__t" title="Game configuration structure.">config_t</a>* pConfig);
<a name="l00037"></a>00037 
<a name="l00042"></a>00042 <span class="keywordtype">void</span> <a class="code" href="../../d7/d82/dedalus_8c.html#a2ef30c42cbc289d899a8be5d2d8f77d0" title="Display the program usage.">usage</a>();
<a name="l00043"></a>00043 
<a name="l00051"></a><a class="code" href="../../d7/d82/dedalus_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00051</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/d82/dedalus_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="Main of Dedalus.">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {
<a name="l00052"></a>00052   <span class="comment">// INIT Srand</span>
<a name="l00053"></a>00053   srand((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)time(NULL));
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <span class="comment">// acquiring program parameters</span>
<a name="l00056"></a>00056   <a class="code" href="../../db/d16/config_8h.html#d8/dc0/structconfig__t" title="Game configuration structure.">config_t</a> config = <a class="code" href="../../d3/d95/config_8c.html#a0a9bc098545e3796b7d31803ab4f2a0a" title="Return an initialized configuration with default values.">config_init</a>();
<a name="l00057"></a>00057   <a class="code" href="../../d7/d82/dedalus_8c.html#a8437a66ad88c77ef751aeb438166b96c" title="Parse parameters to build the configuration of the game.">read_parameters</a>(argc, argv, &amp;config);
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   <a class="code" href="../../dc/db7/map_8h.html#d6/da3/structmap__t" title="A map of the dedalus (one level).">map_t</a> map;
<a name="l00060"></a>00060   <span class="keywordtype">bool</span> mapLoaded = <a class="code" href="../../d3/d7a/map_8c.html#ab4381cb5c72f00e9c91d5b17fd908e0f" title="Read a map from a file.">map_reader</a>(config.<a class="code" href="../../db/d16/config_8h.html#aee6ccc51318bbd8f3238978f5a87e0a2" title="Path to the map file.">mapFile</a>, &amp;map, config.<a class="code" href="../../db/d16/config_8h.html#a6abbfb9281286d0286efe758fb2738b6" title="Max width of a map.">mapMaxXSize</a>);
<a name="l00061"></a>00061   <span class="keywordflow">if</span> (!mapLoaded) {
<a name="l00062"></a>00062     <a class="code" href="../../db/d85/display_8c.html#a883aa14dcc44cb852a0d21bbcb44ee79" title="Display a fatal error.">display_fatal_error</a>(stderr, <span class="stringliteral">&quot;Invalid map !\n&quot;</span>);
<a name="l00063"></a>00063     <span class="keywordflow">return</span> EXIT_FAILURE;
<a name="l00064"></a>00064   }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   <span class="comment">// Init game from initial map</span>
<a name="l00067"></a>00067   <a class="code" href="../../d2/dd5/game_8h.html#da/d7f/structgame__t" title="Structure of a game.">game_t</a> game;
<a name="l00068"></a>00068   <span class="keywordflow">if</span> (!<a class="code" href="../../d1/dcb/game_8c.html#a910409532ed7ad48563233e82cb8a65b" title="Initialize a game.">game_init</a>(&amp;game, &amp;config, config.<a class="code" href="../../db/d16/config_8h.html#aee6ccc51318bbd8f3238978f5a87e0a2" title="Path to the map file.">mapFile</a>, &amp;map, 100,
<a name="l00069"></a>00069                  <a class="code" href="../../d5/d37/ai_8c.html#a562bd2fb06f9e4c147579be9ab214c65" title="AI factory.">ai_new</a>(<a class="code" href="../../d2/d71/ai__random_8c.html#a99a44eeb83f1626852b8f0bb69213d0a" title="Get the name of the random AI class.">ai_random_get_name</a>()), 10,
<a name="l00070"></a>00070                  <a class="code" href="../../d5/d37/ai_8c.html#a562bd2fb06f9e4c147579be9ab214c65" title="AI factory.">ai_new</a>(<a class="code" href="../../d2/d71/ai__random_8c.html#a99a44eeb83f1626852b8f0bb69213d0a" title="Get the name of the random AI class.">ai_random_get_name</a>()))) {
<a name="l00071"></a>00071     <a class="code" href="../../d3/d7a/map_8c.html#a682efebc53a6d7ca7bfcaf5d9c1f7a5e" title="Clear the content of the map.">map_delete</a>(&amp;map);
<a name="l00072"></a>00072     <a class="code" href="../../db/d85/display_8c.html#a883aa14dcc44cb852a0d21bbcb44ee79" title="Display a fatal error.">display_fatal_error</a>(stderr, <span class="stringliteral">&quot;Wrong map (no player or no exit)!\n&quot;</span>);
<a name="l00073"></a>00073     <span class="keywordflow">return</span> EXIT_FAILURE;
<a name="l00074"></a>00074   }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <span class="comment">// Start game</span>
<a name="l00077"></a>00077   <a class="code" href="../../db/d85/display_8c.html#a07ce7a3216adf42f7d610ec15f793b9c" title="Wait a user interaction.">display_wait_user</a>(stdout, <span class="stringliteral">&quot;Press any key to start...&quot;</span>, game.<a class="code" href="../../d2/dd5/game_8h.html#aa6aaa04e0e3d3db2f934506c80401261" title="Ask for interactive actions from GM.">interactive</a>);
<a name="l00078"></a>00078   <a class="code" href="../../d1/dcb/game_8c.html#a16856957dec0a00498b658099771e2a1" title="Run an initialised game.">game_start</a>(&amp;game);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080   <a class="code" href="../../db/d85/display_8c.html#a07ce7a3216adf42f7d610ec15f793b9c" title="Wait a user interaction.">display_wait_user</a>(stdout, <span class="stringliteral">&quot;Press any key to finish...&quot;</span>, game.<a class="code" href="../../d2/dd5/game_8h.html#aa6aaa04e0e3d3db2f934506c80401261" title="Ask for interactive actions from GM.">interactive</a>);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   <span class="comment">// Clear at the end</span>
<a name="l00083"></a>00083   <a class="code" href="../../d1/dcb/game_8c.html#a47943964cf4e581384cb99ac726da589" title="Clear all allocated content of a game.">game_delete</a>(&amp;game);
<a name="l00084"></a>00084   <a class="code" href="../../d3/d95/config_8c.html#a1b03f7f5276ac5b2a785fba6fe10662d" title="Clear a configuration.">config_delete</a>(&amp;config);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086   <span class="keywordflow">return</span> EXIT_SUCCESS;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="../../d7/d82/dedalus_8c.html#a8437a66ad88c77ef751aeb438166b96c">00089</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d82/dedalus_8c.html#a8437a66ad88c77ef751aeb438166b96c" title="Parse parameters to build the configuration of the game.">read_parameters</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[], <a class="code" href="../../db/d16/config_8h.html#d8/dc0/structconfig__t" title="Game configuration structure.">config_t</a>* pConfig) {
<a name="l00090"></a>00090   <span class="comment">/* Parameters parsing */</span>
<a name="l00091"></a>00091   <span class="keywordtype">int</span> c = 0;
<a name="l00092"></a>00092   <span class="keywordtype">int</span> errflg = 0;
<a name="l00093"></a>00093   <span class="keywordtype">int</span> mandatory = 0;
<a name="l00094"></a>00094   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tmp = 0;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;had:m:M:p:&quot;</span>)) != -1) {
<a name="l00097"></a>00097     <span class="keywordflow">switch</span> (c) {
<a name="l00098"></a>00098       <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:  <span class="comment">// help.</span>
<a name="l00099"></a>00099         <a class="code" href="../../d7/d82/dedalus_8c.html#a2ef30c42cbc289d899a8be5d2d8f77d0" title="Display the program usage.">usage</a>();
<a name="l00100"></a>00100         exit(EXIT_SUCCESS);
<a name="l00101"></a>00101         <span class="keywordflow">break</span>;
<a name="l00102"></a>00102       <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:  <span class="comment">// map file.</span>
<a name="l00103"></a>00103         pConfig-&gt;<a class="code" href="../../db/d16/config_8h.html#aee6ccc51318bbd8f3238978f5a87e0a2" title="Path to the map file.">mapFile</a> = optarg;
<a name="l00104"></a>00104         ++mandatory;
<a name="l00105"></a>00105         <span class="keywordflow">break</span>;
<a name="l00106"></a>00106       <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:  <span class="comment">// player display (pid).</span>
<a name="l00107"></a>00107         tmp = strtoul(optarg, NULL, 0);
<a name="l00108"></a>00108         <span class="keywordflow">if</span> (tmp &gt; INT_MAX) {
<a name="l00109"></a>00109           ++errflg;
<a name="l00110"></a>00110         }
<a name="l00111"></a>00111         <a class="code" href="../../d3/d95/config_8c.html#aa6e16370c90e458ca00f331dfdc3a2d1" title="Add a display in the configuration.">config_add_display</a>(pConfig, (pid_t)tmp);
<a name="l00112"></a>00112         <span class="keywordflow">break</span>;
<a name="l00113"></a>00113       <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:  <span class="comment">// max moves for players.</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         tmp = strtoul(optarg, NULL, 0);
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (tmp &gt; INT_MAX) {
<a name="l00117"></a>00117           ++errflg;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119         pConfig-&gt;<a class="code" href="../../db/d16/config_8h.html#aa58b7d6fdd0cfa0b4a3fe9ea5f8bcf08" title="Maximum number of moves for players.">maxMoves</a> = (int)tmp;
<a name="l00120"></a>00120         <span class="keywordflow">break</span>;
<a name="l00121"></a>00121       <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:  <span class="comment">// delay between frames.</span>
<a name="l00122"></a>00122         tmp = strtoul(optarg, NULL, 0);
<a name="l00123"></a>00123         <span class="keywordflow">if</span> (tmp &gt; INT_MAX) {
<a name="l00124"></a>00124           ++errflg;
<a name="l00125"></a>00125         }
<a name="l00126"></a>00126         pConfig-&gt;<a class="code" href="../../db/d16/config_8h.html#a60bcd093651b6045977ee457bf177c0e" title="Time (in us) between frames.">delay</a> = (int)tmp;
<a name="l00127"></a>00127         <span class="keywordflow">break</span>;
<a name="l00128"></a>00128       <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:  <span class="comment">// automatic mode (not interactive).</span>
<a name="l00129"></a>00129         pConfig-&gt;<a class="code" href="../../db/d16/config_8h.html#ad4b9d5f104e8472c73f2da99cb21160c" title="Ask for interactive actions from GM.">interactive</a> = <span class="keyword">false</span>;
<a name="l00130"></a>00130         <span class="keywordflow">break</span>;
<a name="l00131"></a>00131       <span class="keywordflow">case</span> <span class="charliteral">&#39;:&#39;</span>: <span class="comment">/* option without operand */</span>
<a name="l00132"></a>00132         fprintf(stderr, <span class="stringliteral">&quot;Option -%c requires an operand\n&quot;</span>, optopt);
<a name="l00133"></a>00133         ++errflg;
<a name="l00134"></a>00134         <span class="keywordflow">break</span>;
<a name="l00135"></a>00135       <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:
<a name="l00136"></a>00136         fprintf(stderr, <span class="stringliteral">&quot;Unrecognized option: -%c\n&quot;</span>, optopt);
<a name="l00137"></a>00137         ++errflg;
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139   }
<a name="l00140"></a>00140   <span class="keywordflow">if</span> (mandatory != 1) {
<a name="l00141"></a>00141     fprintf(stderr, <span class="stringliteral">&quot;ERROR: mandatory option is missing (-m).\n&quot;</span>);
<a name="l00142"></a>00142     ++errflg;
<a name="l00143"></a>00143   }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145   <span class="keywordflow">if</span> (errflg) {
<a name="l00146"></a>00146     <a class="code" href="../../d7/d82/dedalus_8c.html#a2ef30c42cbc289d899a8be5d2d8f77d0" title="Display the program usage.">usage</a>();
<a name="l00147"></a>00147     exit(EXIT_FAILURE);
<a name="l00148"></a>00148   }
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="keywordtype">void</span> <a class="code" href="../../d7/d82/dedalus_8c.html#a2ef30c42cbc289d899a8be5d2d8f77d0" title="Display the program usage.">usage</a>() {
<a name="l00152"></a>00152   fprintf(stderr,
<a name="l00153"></a>00153           <span class="stringliteral">&quot;Usage: ./Dedalus [-h] -m arg [-M arg] [-d arg] [-a] [-p arg -p arg  &quot;</span>
<a name="l00154"></a>00154           <span class="stringliteral">&quot;...]    \n&quot;</span>);
<a name="l00155"></a>00155   fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00156"></a>00156   fprintf(stderr, <span class="stringliteral">&quot;Options: \n&quot;</span>);
<a name="l00157"></a>00157   fprintf(stderr, <span class="stringliteral">&quot;\t -m arg \t (Mandatory) file of the map.\n&quot;</span>);
<a name="l00158"></a>00158   fprintf(stderr, <span class="stringliteral">&quot;\t -p arg \t (Multiple) PID of the player terminal.\n&quot;</span>);
<a name="l00159"></a>00159   fprintf(stderr, <span class="stringliteral">&quot;\t -d arg \t [100000] Delay (in μs).\n&quot;</span>);
<a name="l00160"></a>00160   fprintf(stderr, <span class="stringliteral">&quot;\t -a     \t [false] Automatic mode (not interactive).\n&quot;</span>);
<a name="l00161"></a>00161   fprintf(stderr, <span class="stringliteral">&quot;\t -M arg \t [1000] Maximum number of steps for players.\n&quot;</span>);
<a name="l00162"></a>00162   fprintf(stderr, <span class="stringliteral">&quot;\t -h     \t Display this message. \n&quot;</span>);
<a name="l00163"></a>00163 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 5 2019 11:25:12 for Operating System 2: Let's play in the dedalus! by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
